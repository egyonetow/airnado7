<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ø´Ø±Ù - Ù„Ø¹Ø¨Ø© Ø§Ù„Ø·ÙŠØ§Ø±Ø©</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 30px;
    }
    h1, h2, h3 {
      text-align: center;
      color: #ffd700;
    }
    .admin-section {
      margin-top: 30px;
    }
    input, button, select, textarea {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: none;
      border-radius: 8px;
    }
    button {
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .user-log, .withdraw-log {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .withdraw-actions button {
      padding: 6px 12px;
      margin-left: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .accept { background: #4CAF50; color: white; }
    .reject { background: #f44336; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¯ Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ø´Ø±Ù</h1><div id="adminLogin">
  <input type="text" id="adminUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
  <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="adminPanel" style="display:none">
  <h2>ğŸ’¥ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ø·Ù…</h2>
  <div id="crashPointList"></div>

  <div class="admin-section">
    <h3>ğŸ“‹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
    <div id="userList"></div>
    <input type="text" id="targetUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
    <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø¥Ø¶Ø§ÙØªÙ‡" />
    <button onclick="addBalance()">Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯</button>
  </div>

  <div class="admin-section">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div id="withdrawRequests"></div>
  </div>

  <div class="admin-section">
    <h3>ğŸ“¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
    <select id="userSelector"></select>
    <div id="chatBox" style="max-height:300px; overflow-y:auto; background:#0002; padding:10px; border-radius:10px;"></div>
    <textarea id="adminMessage" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." rows="3"></textarea>
    <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

  </div>  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, doc, getDoc, updateDoc, getDocs, query, where, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    async function login() {
      const user = document.getElementById("adminUser").value;
      const pass = document.getElementById("adminPass").value;
      if (user === "BASHA" && pass === "000000") {
        document.getElementById("adminLogin").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadCrashPoints();
        loadUsers();
        loadWithdraws();
        loadUsersForMessages();
        startAdminMessageWatcher();
      } else {
        alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }

    async function loadCrashPoints() {
      const list = document.getElementById("crashPointList");
      const local = JSON.parse(localStorage.getItem("crashPointsLog") || "[]");
      list.innerHTML = local.reverse().slice(0, 10).map(p => `<div>ğŸ’¥ ${p.toFixed(2)}x</div>`).join("");
    }

    async function loadUsers() {
      const snapshot = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        userList.innerHTML += `<div class='user-log'>${data.username} â€” ğŸ’° ${data.balance?.toFixed(2) ?? 0} USDT</div>`;
      });
    }

    async function addBalance() {
      const username = document.getElementById("targetUser").value;
      const amount = parseFloat(document.getElementById("amount").value);
      if (!username || isNaN(amount)) return alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      const ref = doc(db, "users", username);
      const userDoc = await getDoc(ref);
      if (!userDoc.exists()) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      const current = userDoc.data();
      const newBal = (current.balance || 0) + amount;
      await updateDoc(ref, { balance: newBal });
      alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯");
      loadUsers();
    }

    async function loadWithdraws() {
      const container = document.getElementById("withdrawRequests");
      container.innerHTML = "";
      const q = query(collection(db, "withdraw_requests"), where("status", "==", "pending"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        container.innerHTML += `
          <div class='withdraw-log'>
            ğŸ§¾ <strong>${d.username}</strong> ÙŠØ·Ù„Ø¨ <strong>${d.amount}</strong> USDT<br>
            <strong>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©:</strong> ${d.method}<br>
            <strong>Ø§Ù„Ø­Ø³Ø§Ø¨:</strong> ${d.account}<br>
            <small>${new Date(d.requestedAt).toLocaleString()}</small>
            <div class="withdraw-actions">
              <button class="accept" onclick="handleWithdrawAction('${docSnap.id}', true)">Ù‚Ø¨ÙˆÙ„</button>
              <button class="reject" onclick="handleWithdrawAction('${docSnap.id}', false)">Ø±ÙØ¶</button>
            </div>
          </div>`;
      });
    }

    async function handleWithdrawAction(id, accept) {
      const ref = doc(db, "withdraw_requests", id);
      await updateDoc(ref, { status: accept ? "approved" : "rejected" });
      loadWithdraws();
    }

    window.handleWithdrawAction = handleWithdrawAction;

    async function loadUsersForMessages() {
      const snapshot = await getDocs(collection(db, "users"));
      const selector = document.getElementById("userSelector");
      selector.innerHTML = "";
      snapshot.forEach(doc => {
        const u = doc.data();
        selector.innerHTML += `<option value="${u.username}">${u.username}</option>`;
      });
      selector.onchange = loadChat;
      loadChat();
    }

    async function loadChat() {
      const user = document.getElementById("userSelector").value;
      const chatBox = document.getElementById("chatBox");
      const q = query(collection(db, "messages"), where("from", "in", ["admin", user]), where("to", "in", ["admin", user]), orderBy("timestamp"));
      const snapshot = await getDocs(q);
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const m = doc.data();
        chatBox.innerHTML += `<div><b>${m.from}:</b> ${m.message}</div>`;
      });
    }

    async function sendMessage() {
      const user = document.getElementById("userSelector").value;
      const message = document.getElementById("adminMessage").value;
      if (!message) return alert("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹");
      await addDoc(collection(db, "messages"), {
        from: "admin",
        to: user,
        message,
        timestamp: new Date().toISOString(),
        seen: false
      });
      document.getElementById("adminMessage").value = "";
      loadChat();
    }

    function startAdminMessageWatcher() {
      setInterval(async () => {
        const q = query(collection(db, "messages"), where("to", "==", "admin"), where("seen", "!=", true), orderBy("timestamp"));
        const snapshot = await getDocs(q);
        snapshot.forEach(async (msgDoc) => {
          const msg = msgDoc.data();
          alert(`ğŸ“© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${msg.from}:\n${msg.message}`);
          await updateDoc(doc(db, "messages", msgDoc.id), { seen: true });
        });
      }, 30000);
    }
  </script></body>
</html>